#!/bin/bash

# Smart Trip Planner - Setup Script
# This script automates the setup process for development

set -e

echo "ðŸš€ Smart Trip Planner - Automated Setup"
echo "========================================"
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_success() {
    echo -e "${GREEN}âœ“ $1${NC}"
}

print_error() {
    echo -e "${RED}âœ— $1${NC}"
}

print_info() {
    echo -e "${YELLOW}â„¹ $1${NC}"
}

# Check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check prerequisites
echo "Checking prerequisites..."

if ! command_exists python3; then
    print_error "Python 3 is not installed. Please install Python 3.11 or higher."
    exit 1
fi
print_success "Python 3 found"

if ! command_exists psql; then
    print_error "PostgreSQL is not installed. Please install PostgreSQL 15+."
    exit 1
fi
print_success "PostgreSQL found"

if ! command_exists redis-cli; then
    print_error "Redis is not installed. Please install Redis 7+."
    exit 1
fi
print_success "Redis found"

if ! command_exists flutter; then
    print_error "Flutter is not installed. Please install Flutter 3.16+."
    exit 1
fi
print_success "Flutter found"

echo ""
echo "All prerequisites met!"
echo ""

# Setup Backend
echo "ðŸ“¦ Setting up Backend..."
echo ""

cd backend

# Create virtual environment
if [ ! -d "venv" ]; then
    print_info "Creating virtual environment..."
    python3 -m venv venv
    print_success "Virtual environment created"
fi

# Activate virtual environment
source venv/bin/activate

# Install dependencies
print_info "Installing Python dependencies..."
pip install -q --upgrade pip
pip install -q -r requirements.txt
print_success "Dependencies installed"

# Setup environment variables
if [ ! -f ".env" ]; then
    print_info "Creating .env file..."
    cp .env.example .env
    
    # Generate secret key
    SECRET_KEY=$(python3 -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())')
    
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        sed -i '' "s|SECRET_KEY=.*|SECRET_KEY=$SECRET_KEY|g" .env
    else
        # Linux
        sed -i "s|SECRET_KEY=.*|SECRET_KEY=$SECRET_KEY|g" .env
    fi
    
    print_success ".env file created with random secret key"
    print_info "Please edit .env to configure database and email settings"
fi

# Setup database
print_info "Setting up database..."
read -p "Do you want to create the database? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    DB_NAME=$(grep DB_NAME .env | cut -d '=' -f2)
    DB_USER=$(grep DB_USER .env | cut -d '=' -f2)
    DB_PASSWORD=$(grep DB_PASSWORD .env | cut -d '=' -f2)
    
    # Create database
    sudo -u postgres psql -c "CREATE DATABASE $DB_NAME;" 2>/dev/null || true
    sudo -u postgres psql -c "CREATE USER $DB_USER WITH PASSWORD '$DB_PASSWORD';" 2>/dev/null || true
    sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;" 2>/dev/null || true
    
    print_success "Database created"
fi

# Run migrations
print_info "Running migrations..."
python manage.py migrate
print_success "Migrations completed"

# Create superuser
read -p "Do you want to create a superuser? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    python manage.py createsuperuser
fi

# Create logs directory
mkdir -p logs
print_success "Backend setup completed"

cd ..

echo ""
echo "ðŸ“± Setting up Frontend..."
echo ""

cd frontend

# Install Flutter dependencies
print_info "Installing Flutter dependencies..."
flutter pub get
print_success "Dependencies installed"

# Generate code
print_info "Generating code..."
flutter pub run build_runner build --delete-conflicting-outputs
print_success "Code generation completed"

# Configure API endpoint
print_info "Configuring API endpoint..."
print_info "Please update the baseUrl in lib/services/api_service.dart"

print_success "Frontend setup completed"

cd ..

echo ""
echo "âœ… Setup Complete!"
echo ""
echo "To start the application:"
echo ""
echo "Backend:"
echo "  cd backend"
echo "  source venv/bin/activate"
echo "  python manage.py runserver"
echo ""
echo "Frontend:"
echo "  cd frontend"
echo "  flutter run"
echo ""
echo "Access the API documentation at: http://localhost:8000/swagger/"
echo ""
echo "Happy coding! ðŸŽ‰"